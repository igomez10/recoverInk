<!DOCTYPE html>

<html lang="en">

    <head>
      <!-- Load the webcomponent polyfill -->
      <script src="bower_components/webcomponentsjs/webcomponents-loader.js"></script>
      <!-- Load myscript-text-web and the related librairies -->
      <link rel="import" href="bower_components/myscript-text-web/myscript-text-web.html">
      <!-- Compiled and minified CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
        <!--Let browser know website is optimized for mobile-->
              <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <body>
        <div>
            <h1>Try to write the following </h1>
            <p id='todelete'></p>
            <h2 id="quiz"></h2>
            <button onclick="clearField()">CLEAR</button>
            <div>
              <h1>Score: </h1>
              <h2 id=score></h2>
            </div>
        </div>
        <paper-toast id="result" class="fit-top"></paper-toast>
        <myscript-text-web apiversion="V3"
                           scheme="https"
                           host="webdemoapi.myscript.com"
                           applicationkey="f6c15b34-dbbf-4908-a796-309e3f053222"
                           hmackey="7ddfc6fe-e0c6-4c14-aba0-b777bb370d94"
                           textinputmode="CURSIVE"
                           textcandidatelistsize="20"
                           disableexportcontrol
                           disableconvertcontrol
                           touch-action="none"
                           style="height:400px"
                           id="myscript">
        </myscript-text-web>
        <myscript-text-exports
                exports="myscript-text-web.exports">
        </myscript-text-exports>

        <p id="stats"></p>
        <script>

                userScore = 0;
                counter = 0;
                    function getRandomChar() {
                          var text = "";
                            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                              counter = counter + 1;
                              text += possible.charAt(Math.floor(Math.random() * possible.length));
                              return text;

                    }
                    const load = () => {
                            console.log("load event detected!");
                            document.getElementById("quiz").innerHTML=`${getRandomChar()}`;
                    }
            window.onload = load;
            const paperToast = document.querySelector('paper-toast');

           document.querySelector('myscript-text-web').addEventListener('exported', function (event) {
               // paperToast.text = `Recognition object contains : ${JSON.stringify(event.detail)}`;
               // document.getElementById('todelete').innerHTML = JSON.stringify(event.detail.exports.CANDIDATES.textSegmentResult.candidates)
               try{
                    var candidateArray = event.detail.exports.CANDIDATES.textSegmentResult.candidates
                   console.log(candidateArray)
                   var objective = document.getElementById('quiz').innerHTML
                   for(var i = 0 ; i < candidateArray.length ; i++) {
                     if(objective == candidateArray[i].label){
                        let normScore = candidateArray[i].normalizedScore;
                        userScore = (normScore + counter*userScore)/(counter + 1);
                       console.log("FOUND MY OBJECTIVE");
                       document.getElementById('score').innerHTML = userScore;
                       break;
                     }
                     else{
                        console.log("OBJECTIVE NOT FOUND")
                     }
                   }
                    setTimeout(()=>{
                        document.querySelector('myscript-text-web').clear()
                        document.getElementById("quiz").innerHTML=`${getRandomChar()}`;
                    },5000);

             }
             catch(err) {

             }
           });

           var clearField = () => {
             document.querySelector('myscript-text-web').clear()
             load()
           }
        </script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
          <!-- Compiled and minified JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    </body>

</html>
